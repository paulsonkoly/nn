#!/usr/bin/env ruby

require "bundler/setup"
require "nn"
require 'image'
require 'matrix_shim'
require 'ruby-progressbar'

# You can add fixtures and/or initialization code here to make experimenting
# with your gem easier. You can also use a different console, if you like.

bar = ProgressBar.create format: "Loading training set |%B| %p%"
bar.total = 50_000
@training_data = 50_000.times.map do |offset|
  image = Image.read_from_files(datafile: 'train-images-idx3-ubyte',
                                labelfile: 'train-labels-idx1-ubyte',
                                offset: offset)
  bar.increment
  [Nn::Matrix.new(image.data), image.value]
end

bar = ProgressBar.create format: "Loading test data |%B| %p%"
bar.total = 10_000
@test_data = 10_000.times.map do |offset|
  image = Image.read_from_files(datafile: 'train-images-idx3-ubyte',
                                labelfile: 'train-labels-idx1-ubyte',
                                offset: 50_000 + offset)
  bar.increment
  [Nn::Matrix.new(image.data), image.value]
end

@net = Nn::Network.new(784, 30, 10)
pp "set variables are: @net, @training_data, @test_data"
pp "run @net.sgd(@training_data, 30, 10, 3.0, @test_data)"

@net.sgd(@training_data, 30, 10, 3.0, @test_data)

# (If you use this, don't forget to add pry to your Gemfile!)
require "pry"
Pry.start
